# Ariadne 计划文档审查总结

**审查日期**: 2026-02-01
**审查文档**: `docs/plans/2026-01-31-feat-ariadne-codebase-knowledge-graph-plan.md`
**审查方式**: 5个专业代理并行分析

---

## 执行摘要

| 代理 | 评分 | 主要发现 |
|------|------|----------|
| 架构策略师 | 8/10 | 关注点分离良好，但有耦合问题 |
| 代码简化审查员 | 5/10 | 约40%代码可简化 |
| 性能预言家 | 6/10 | NFR目标不现实，N+1查询 |
| 通用审查员 | 6/10 | 阶段状态过时，文档不完整 |

---

## 🔴 关键问题

### 1. 计划文档状态过时

**位置**: 第154-290行

**问题**: 计划文档显示的阶段完成状态与实际不符：

| 阶段 | 文档状态 | 实际状态 | 完成提交 |
|------|----------|----------|----------|
| Phase 1 (L3) | `[x]` | ✅ 完成 | 8a67c6e |
| Phase 2 (L2) | `[ ]` | ✅ 完成 | e56f85a |
| Phase 3 (L1) | `[ ]` | ✅ 完成 | 519ae9e, b9f6419 |
| Phase 4 (API) | `[ ]` | ✅ 完成 | 09605e2 |

**建议**: 更新计划文档，标记所有阶段为已完成。

---

## 🟡 架构问题

### 2. L1-L2-L3 层耦合

**问题**: L1 层通过外键直接依赖 L3 符号，如果 L3 数据过期或不完整，L1 摘要将孤立。

**建议**: 添加 `is_stale` 标志的一致性检查机制。

### 3. 缺少服务层抽象

**问题**: 路由直接耦合到存储层（SQLiteStore + ChromaDB），无统一查询层。

**建议**: 引入仓储模式或查询服务层。

### 4. 向量-SQL 数据一致性

**问题**: 双存储系统无事务保证，写入 SQLite 成功但 ChromaDB 失败会导致不一致。

**建议**: 实现写前日志或最终一致性协调。

---

## 🟡 性能问题

### 5. SQLite 递归 CTE 扩展性

**问题**: 深度 > 10 时查询时间呈指数增长。

| 深度 | 节点数 | 预计时间 |
|------|--------|----------|
| 5 | ~363 | 50-100ms |
| 10 | ~88,573 | 500ms-2s |
| 15 | ~21M | 10-30s (超时) |

**建议**:
- 默认 max_depth = 10
- 添加超时限制
- 预留 Neo4j 升级路径

### 6. N+1 查询模式

**位置**: `impact_analyzer.py`

**问题**: 对于 100 个调用者执行 101 次查询（1 次 CTE + 100 次符号查找）。

**建议**: 在 CTE 中 JOIN symbols 表，一次性获取所有数据。

### 7. 无缓存策略

**问题**: 每个相同查询都从头计算，浪费资源。

**建议**:
- LRU 查询结果缓存
- LLM 响应磁盘缓存
- 60-80% 命中率预期

### 8. NFR 目标不现实

| 指标 | 目标 | 现实 |
|------|------|------|
| 图查询响应 | < 500ms | 仅深度 <=10、小型代码库 |
| 增量更新 | < 2分钟 | 仅 < 100 个变更方法 |

---

## 🟡 过度工程问题

### 9. 三层架构可简化 (~400 LOC)

**问题**: L1/L2/L3 人为划分，可合并为带节点类型的单一分析器。

**影响**: 目录结构 + 层协调代码约 400 行。

### 10. 双存储不必要复杂度 (~500 LOC)

**问题**: SQLite + ChromaDB 双存储增加同步复杂度。

**建议**:
- **选项 A**: 使用 `sqlite-vec` 扩展（单存储）
- **选项 B**: MVP 跳过向量搜索，使用 SQLite FTS5 全文搜索

**影响**: 移除 ~500 行双存储协调代码。

### 11. 分层摘要过度设计 (~200 LOC)

**问题**: 方法 → 类 → 包 → 模块 4 层摘要过于复杂。

**建议**: MVP 仅类级摘要，按需生成。

**影响**: 移除 ~200 行代码，LLM 成本降低 75%。

### 12. HTTP API 过早实现 (~2600 LOC)

**问题**: 在证明核心价值之前构建完整 HTTP API。

**建议**: MVP 仅 CLI 接口，等到需要外部系统集成时再添加 API。

**影响**: 推迟 ~2600 行 API 代码。

### 13. 作业队列 YAGNI 违规 (~150 LOC)

**问题**: 为重建操作构建异步作业队列系统。

**建议**: MVP 同步重建即可，等到实际需要 Web 触发时再添加异步。

**影响**: 移除 ~150 行代码，2 个数据库表。

---

## 🟡 文档完整性问题

### 14. CLI 参考未文档化

**问题**: 计划提到 CLI 命令但未指定：
- 完整 CLI 命令参考
- 所有可用选项和标志
- CLI 配置文件格式

### 15. 部署/运维缺失

**问题**: 无以下方面指导：
- 生产部署配置
- 环境变量要求
- 服务健康监控
- SQLite + ChromaDB 备份/恢复

### 16. 安全考虑最少

**问题**: 安全部分最少，缺失：
- API 身份认证/授权详情
- 速率限制配置
- 输入验证策略

### 17. 增量更新策略未指定

**问题**: 第 277-280 行提到 "Git Hook 集成" 但无：
- 具体 hook 示例
- 文件变更检测算法
- 级联更新策略详情

### 18. 验收标准不可测试

**问题**: 某些标准缺乏具体性：
- "支持深度限制" - 限制是多少？
- "识别隐式约束" - 什么类型约束？
- "MRR@10 >= 0.7" - 如何测量？测试集是什么？

---

## ✅ 正面发现

### 19. 良好的架构分层

**位置**: 第 43-78 行

三层知识架构提供优秀的关注点分离：
- L3: 符号提取、关系图
- L2: 调用链、依赖、模式
- L1: 业务语义、领域词汇、约束

### 20. 实用的增量构建策略

**位置**: 第 154-290 行

四个阶段的实施方式务实：
- 每阶段产生可工作的、可测试的产物
- 依赖顺序（L3 → L2 → L1 → API）合乎逻辑

### 21. 合适的技术选择

| 组件 | 技术 | 评估 |
|------|------|------|
| 代码解析 | ASM 字节码 | 优秀 - 100% 准确 |
| 图存储 | SQLite + 递归 CTE | 中等项目良好，可升级到 Neo4j |
| 向量存储 | ChromaDB | 适当 - 本地、轻量 |
| HTTP API | FastAPI + Pydantic | 优秀 - 现代、类型安全 |

### 22. 良好的模式设计

**位置**: 第 296-441 行

数据库模式展示良好实践：
- 良好的规范化
- 适当的索引
- 参照完整性
- 级联删除

### 23. 现实的验收场景

**位置**: 第 510-578 行

三个场景（规划辅助、防遗漏、规范检查）真实且全面。

---

## 📋 建议的后续行动

### 高优先级 🔴

1. **更新计划文档** - 标记所有阶段为已完成
2. **修复 N+1 查询** - 在 impact_analyzer 中使用 JOIN
3. **添加查询结果缓存**
4. **添加深度限制** - 默认 max_depth = 10

### 中优先级 🟡

5. **添加 CLI 参考部分**
6. **添加部署/运维部分**
7. **明确验收指标** - 更具体的测试程序
8. **添加数据一致性策略** - SQLite + ChromaDB 同步

### 低优先级 🟢

9. **简化架构** - 考虑合并 L1/L2/L3
10. **整合存储** - 考虑单存储方案
11. **添加 LLM 成本估算指南**
12. **添加"已知问题"部分**

---

## 总结表

| 方面 | 评分 | 主要问题 |
|------|------|----------|
| 完整性 | 6/10 | 阶段状态过时、CLI 未文档化、部署缺失 |
| 清晰度 | 7/10 | 术语不一致、某些概念未详细说明 |
| 可操作性 | 7/10 | 任务清晰，但验收标准需要更具体 |
| 文档质量 | 8/10 | 模式/场景优秀，API 规范需改进 |
| 参考准确性 | 9/10 | 所有路径有效，建议少量添加 |

**整体**: 计划是坚实的基础，但需要更新以反映完成的实现并添加额外的运维文档。

---

## 注意事项

⚠️ **本地开发工具安全例外**

以下安全配置对本地工具是**可接受的**，不应标记为问题：

- CORS: `allow_origins=["*"]`
- 无身份认证
- 默认绑定 `0.0.0.0` (容器内使用)
- X-Forwarded-For 信任

详见 `CLAUDE.md` 和 `docs/reviews/review-guidelines.md`
