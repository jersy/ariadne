---
status: complete
priority: p1
issue_id: "001"
tags:
  - code-review
  - security
  - critical
dependencies: []
---

# Hardcoded API Keys Security Vulnerability

## Problem Statement

Valid API keys for DeepSeek and OpenAI-compatible services are **hardcoded in source code** and committed to the repository. This is a **CRITICAL SECURITY VULNERABILITY** (CWE-798: Use of Hard-coded Credentials).

**Locations:**
- `tests/test_llm_integration.py` (lines 16, 21, 130, 149)
- `tests/demo_l1_features.py` (lines 18, 23, 149, 220)

**Exposed Keys:**
- DeepSeek API Key: `sk-f3169cb3c827406d818f8518d645ea4d`
- OpenAI-compatible API Key: `sk-eevkkfebgwpjrcyxjllfyfpiqtvhzrjsmbjmvmeomvzeonnr`

## Why It Matters

1. **Credential Theft**: Anyone with repository access can use these API keys to incur costs on the victim's account
2. **Git History Exposure**: Even if removed, the keys remain in git history forever
3. **Compliance Violation**: Hardcoded credentials violate security best practices and compliance requirements (SOC2, PCI-DSS, etc.)
4. **Supply Chain Risk**: If repository is public or forked, credentials are permanently exposed

## Findings

### From Security Sentinel Review:

> **Severity:** CRITICAL
> **CVE Class:** CWE-798 (Use of Hard-coded Credentials)
>
> The exposed API keys constitute an immediate security incident requiring urgent remediation. These credentials are committed to git and exposed to anyone with repository access.

### From Kieran Python Reviewer:

> **CRITICAL (Must Fix Before Merge)**
>
> Remove these keys immediately, rotate the compromised keys, and add to `.gitignore`.

### Affected Code Snippets:

```python
# tests/test_llm_integration.py:16-23
os.environ["ARIADNE_DEEPSEEK_API_KEY"] = "sk-f3169cb3c827406d818f8518d645ea4d"
os.environ["ARIADNE_OPENAI_API_KEY"] = "sk-eevkkfebgwpjrcyxjllfyfpiqtvhzrjsmbjmvmeomvzeonnr"
```

## Proposed Solutions

### Solution 1: Immediate Remediation (Recommended)

**Approach:** Remove keys, rotate credentials, and prevent future occurrences

**Pros:**
- Addresses root cause immediately
- Prevents future credential leakage
- Follows security best practices

**Cons:**
- Requires key rotation (may break existing integrations)
- Requires git history cleanup

**Effort:** Medium
**Risk:** Low

**Steps:**
1. **IMMEDIATELY revoke** the exposed API keys through provider dashboards
2. Remove hardcoded keys from test files
3. Clean git history using `git filter-branch` or `BFG Repo-Cleaner`
4. Add `.env.example` file with placeholder values
5. Add pre-commit hook to prevent future key commits
6. Update CI/CD to require environment variables

### Solution 2: Use Environment Variables with Test Skip Pattern

**Approach:** Keep test structure but require environment variables

**Pros:**
- Maintains test structure
- Uses standard 12-factor app patterns
- Tests skip gracefully when keys not present

**Cons:**
- Doesn't address already-exposed keys
- Still requires git history cleanup

**Effort:** Low
**Risk:** Low

**Implementation:**
```python
# tests/test_llm_integration.py
import os
import pytest

load_dotenv()  # Load from .gitignored .env file

if not os.environ.get("ARIADNE_DEEPSEEK_API_KEY"):
    pytest.skip("ARIADNE_DEEPSEEK_API_KEY not set", allow_module_level=True)
```

### Solution 3: Mock API Responses for Tests

**Approach:** Use mocks instead of real API calls

**Pros:**
- No API keys required
- Faster tests
- Deterministic results

**Cons:**
- Doesn't test real integration
- Requires test infrastructure changes

**Effort:** High
**Risk:** Medium

## Recommended Action

**Use Solution 1 (Immediate Remediation)**

This is the only acceptable approach for a CRITICAL security vulnerability.

## Technical Details

### Files to Modify:
1. `tests/test_llm_integration.py` - Remove lines 16, 21, 130, 149
2. `tests/demo_l1_features.py` - Remove lines 18, 23, 149, 220
3. `.gitignore` - Ensure `.env` is ignored (already present)
4. `.env.example` - Create new file with placeholder values
5. `.git/hooks/pre-commit` - Add secret scanning hook

### Pre-commit Hook Addition:
```bash
#!/bin/bash
# Detect and block commits with potential secrets
if git diff --cached --name-only | xargs grep -l "sk-[a-zA-Z0-9]"; then
    echo "ERROR: Potential API key detected in staged files"
    echo "Please remove hardcoded credentials before committing"
    exit 1
fi
```

### Git History Cleanup:
```bash
# Using BFG Repo-Cleaner (recommended)
java -jar bfg.jar --delete-files test_llm_integration.py demo_l1_features.py
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Or using git filter-branch
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch tests/test_llm_integration.py tests/demo_l1_features.py" \
  --prune-empty --tag-name-filter cat -- --all
```

## Acceptance Criteria

- [ ] API keys removed from all source files
- [ ] Exposed keys revoked at provider
- [ ] Git history cleaned of sensitive data
- [ ] `.env.example` file created with placeholders
- [ ] Pre-commit hook installed and tested
- [ ] Tests modified to skip without API keys
- [ ] CI/CD updated to require environment variables
- [ ] Security scan (truffleHog/gitleaks) passes

## Work Log

| Date | Action | Result |
|------|--------|--------|
| 2026-02-01 | Code review completed | Critical vulnerability identified |
| 2026-02-01 | Fixed hardcoded API keys | Removed keys from test files, added .env.example, tests now skip gracefully without keys |

## Resources

- **Files**: `tests/test_llm_integration.py`, `tests/demo_l1_features.py`
- **Git History**: Full git history contains exposed keys
- **Revoke URLs**:
  - DeepSeek: https://platform.deepseek.com/api_keys
  - OpenAI: https://platform.openai.com/api-keys
- **Similar Patterns**: Check other test files for hardcoded credentials
- **Documentation**:
  - CWE-798: https://cwe.mitre.org/data/definitions/798.html
  - Git-secrets: https://github.com/awslabs/git-secrets
  - truffleHog: https://github.com/trufflesecurity/trufflehog
